{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Collector Management | EcoTrack</title>

  <!-- FontAwesome for icons like edit, delete -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- Bootstrap icons (optional additional icons) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    /* =========================== Color Palette =========================== */
    :root {
      /* Background image for the whole page */
      --bg-image: url("{% static 'images/bgimg.jpg' %}");
      /* Gradient used in modal and container backgrounds */
      --container-gradient: linear-gradient(145deg, rgba(4, 57, 39, 0.9), rgba(5, 111, 79, 0.85));
      /* Primary color used for buttons, headings */
      --primary: #04706e;
      /* Secondary color for hover effects */
      --secondary: #2f9080;
      /* Highlight color for text accents */
      --highlight: #85fcde;
      /* Light blue for action icons */
      --light-blue: #85fcde;
      /* Shadow color used for cards, sidebar */
      --shadow: rgba(3, 104, 77, 0.5);
      /* Light text color */
      --text-light: #e6fef3;
      /* Dark text color */
      --text-dark: #0b3d2e;
    }

    /* =========================== Body & Container =========================== */
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg-image) no-repeat center center/cover; /* Full page background */
      color: var(--text-dark);
    }

    .container {
      display: flex; /* Sidebar + main content layout */
      min-height: 100vh; /* Full viewport height */
      background: linear-gradient(to bottom, rgba(255, 255, 255, 0.8), rgba(103, 206, 168, 0.7)); /* Light overlay */
    }

    /* =========================== Sidebar =========================== */
    .sidebar {
      width: 260px; /* Standard sidebar width */
      background: linear-gradient(to bottom, rgba(255, 255, 255, 0.8), rgba(103, 206, 168, 0.7)); /* Gradient effect */
      transition: width 0.3s ease, padding 0.3s ease; /* Smooth collapse animation */
      box-shadow: 2px 0 12px var(--shadow); /* Shadow on right */
      backdrop-filter: blur(12px); /* Slight blur for modern look */
    }

    .sidebar.collapsed {
      width: 70px; /* Collapsed width */
      padding: 0px;
    }

    .sidebar h2 {
      text-align: center;
      padding: 20px 0;
      font-size: 1.6rem;
      margin: 0;
      color: var(--primary);
    }

    .sidebar.collapsed h2 {
      opacity: 0; /* Hide brand text when collapsed */
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar ul li a {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 22px;
      color: var(--text-dark);
      text-decoration: none;
      border-radius: 8px;
      transition: background 0.3s ease;
    }

    .sidebar ul li a:hover {
      background: var(--secondary); /* Hover background for links */
      color: #ffffff;
    }

    .sidebar ul li a.active {
      background: var(--primary); /* Active page highlight */
      color: #ffffff;
      font-weight: bold;
    }

    .sidebar ul li span {
      transition: opacity 0.3s ease;
    }

    .sidebar.collapsed ul li span {
      display: none; /* Hide text when collapsed */
    }

    .toggle-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      font-size: 22px;
      color: var(--text-dark);
      cursor: pointer;
    }

    /* =========================== Main Content =========================== */
    .main {
      flex: 1; /* Take remaining width */
      padding: 24px;
      backdrop-filter: blur(6px); /* Slight blur for readability */
    }

    .header {
      font-size: 26px;
      font-weight: bold;
      color: var(--primary);
      display: flex;
      justify-content: space-between; /* Header + Create button spacing */
      align-items: center;
      margin-bottom: 24px;
    }

    .create-btn {
      padding: 10px 18px;
      background-color: var(--primary);
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s ease;
    }

    .create-btn:hover {
      background-color: var(--secondary);
    }

    /* =========================== Table Styles =========================== */
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px var(--shadow);
    }

    th,
    td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid rgb(65, 236, 190);
    }

    th {
      background: var(--primary); /* Table header background */
      color: white;
    }

    tr:hover {
      background-color: rgba(4, 112, 110, 0.08); /* Hover effect for rows */
    }

    .actions {
      display: flex;
      gap: 10px; /* Spacing between action buttons */
    }

    .action-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      color: var(--light-blue);
      transition: all 0.2s ease-in-out;
    }

    .action-btn:hover {
      color: var(--highlight);
      transform: scale(1.15); /* Slight grow on hover */
    }

    /* =========================== Modals =========================== */
    .modal {
      display: none; /* Hidden by default */
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background: rgba(109, 148, 135, 0.25); /* Overlay background */
      backdrop-filter: blur(12px);
      border: 1px solid #04706e;
    }

    .modal-content {
      background: var(--container-gradient);
      margin: 8% auto;
      padding: 30px;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 16px var(--shadow);
      color: var(--text-light);
      position: relative;
      animation: fadeIn 0.3s ease-in-out;
    }

    .close {
      position: absolute;
      top: 12px;
      right: 16px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: var(--highlight);
      transition: color 0.3s ease;
    }

    .close:hover {
      color: var(--light-blue);
    }

    .modal-content h2 {
      margin-top: 0;
      margin-bottom: 20px;
      color: var(--highlight);
      text-align: center;
    }

    .modal-content label {
      display: block;
      margin-bottom: 6px;
      color: var(--text-light);
    }

    .modal-content input {
      width: 100%;
      padding: 10px;
      margin-bottom: 14px;
      border-radius: 8px;
      border: none;
      background: rgba(255, 255, 255, 0.9);
      color: var(--text-dark);
    }

    .save-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      transition: background 0.3s ease, transform 0.2s;
    }

    .save-btn:hover {
      background: var(--secondary);
      transform: scale(1.05);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* =========================== Profile Dropdown =========================== */
    .profile-menu {
      position: absolute;
      top: 16px;
      right: 30px;
    }

    .profile-img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--primary);
      cursor: pointer;
      display: block;
    }

    .profile-dropdown {
      display: none;
      position: absolute;
      right: 0;
      top: 55px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 15px var(--shadow);
      overflow: hidden;
      z-index: 1000;
      min-width: 150px;
    }

    .profile-dropdown a {
      display: block;
      padding: 10px 14px;
      text-decoration: none;
      color: var(--text-dark);
      font-size: 14px;
      transition: background 0.2s;
    }

    .profile-dropdown a:hover {
      background: var(--secondary);
    }

    /* =========================== Toggle Switch Styles =========================== */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: orange;
      transition: 0.4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 20px; width: 20px;
      left: 3px; bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: limegreen; /* Switch ON */
    }

    input:checked + .slider:before {
      transform: translateX(24px); /* Slide circle */
    }

    /* Rounded switch */
    .slider.round {
      border-radius: 34px;
    }

    .slider.round:before {
      border-radius: 50%;
    }

    /* =========================== Responsive =========================== */
    @media screen and (max-width: 768px) {
      .sidebar {
        position: fixed;
        z-index: 999;
        height: 100%;
      }

      .main {
        margin-left: 70px; /* Adjust main content when sidebar collapsed */
      }

      .sidebar.collapsed + .main {
        margin-left: 70px;
      }
    }

  </style>
</head>

<body>
  <div class="container">
    <!-- =========================== Sidebar =========================== -->
    <div class="sidebar" id="sidebar">
      <h2 id="brandText">EcoTrack</h2>
      <button class="toggle-btn" onclick="toggleSidebar()" aria-label="Toggle Sidebar">‚ò∞</button>
      <ul>
        <!-- Sidebar navigation links -->
        <li><a href="{% url 'ecotracksys:admin_dashboard' %}"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
        <li><a href="{% url 'ecotracksys:pickup_management' %}"><i class="fas fa-trash"></i> <span>Pickup Management</span></a></li>
        <li><a href="{% url 'ecotracksys:leave_request_management' %}"><i class="fas fa-calendar-alt"></i> <span>Leave Requests</span></a></li>
        <li><a href="{% url 'ecotracksys:complaint_management' %}"><i class="fas fa-bullhorn"></i> <span>Complaints</span></a></li>
        <li><a href="{% url 'ecotracksys:user_management' %}"><i class="fas fa-users"></i> <span>User Management</span></a></li>
        <li><a href="{% url 'ecotracksys:collector_management' %}" class="active"><i class="fas fa-user-cog"></i> <span>Collector Management</span></a></li>
        <li><a href="{% url 'ecotracksys:admin_analytics' %}"><i class="fas fa-chart-line"></i> <span>Analytics</span></a></li>
        <li><a href="{% url 'ecotracksys:admin_notifications' %}" ><i class="fas fa-bell"></i> <span>Notifications</span></a></li>
        <li><a href="{% url 'ecotracksys:admin_profile' %}"><i class="fas fa-user-shield"></i> <span>Admin Profile</span></a></li>
      </ul>
    </div>

    <!-- =========================== Main Content =========================== -->
    <div class="main">
      <!-- Profile Menu -->
      <div class="profile-menu">
        {% if user.is_authenticated %}
          {% if request.user.profile_image %}
            <!-- User uploaded profile image -->
            <img src="{{ request.user.profile_image.url }}" alt="Profile Image" class="profile-img" onclick="toggleProfileMenu()">
          {% else %}
            <!-- Default profile image -->
            <img src="{% static 'default_profile.png' %}" alt="Profile Image" class="profile-img" onclick="toggleProfileMenu()">
          {% endif %}
        {% endif %}

        <div class="profile-dropdown" id="profileDropdown">
          <a href="{% url 'ecotracksys:admin_profile' %}">üë§ View Profile</a>
          <a href="{% url 'logout' %}">üö™ Logout</a>
        </div>
      </div>

      <!-- Header + Create button -->
      <div class="header">
        <h1>
          Collector Management
          <button class="create-btn" onclick="openAddCollectorModal()">+ New Collector</button>
        </h1>
      </div>

      <!-- Display Django messages (success/error) -->
      {% if messages %}
      <div style="margin-bottom: 16px;">
        {% for message in messages %}
        <div style="color: {% if message.tags == 'error' %}red{% else %}lime{% endif %}; font-weight: bold;">
          {{ message }}
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- =========================== Collector Table =========================== -->
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Phone</th>
            <th>Email</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for collector in collectors %}
          <tr>
            <td>{{ collector.name }}</td>
            <td>{{ collector.phone }}</td>
            <td>{{ collector.email }}</td>
            <td class="actions">
              <!-- Edit Button with JS modal trigger -->
              <button class="action-btn" title="Edit" onclick='openEditCollectorModal({
                id: {{ collector.id }},
                name: "{{ collector.name|escapejs }}",
                email: "{{ collector.email|escapejs }}",
                phone: "{{ collector.phone|escapejs }}"
                })'>‚úèÔ∏è
              </button>

              <!-- Delete Button with JS modal trigger -->
              <button class="action-btn" title="Delete" onclick="openDeleteCollectorModal({{ collector.id }}, '{{ collector.name|escapejs }}')">üóëÔ∏è</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- =========================== Modals =========================== -->
      <!-- Add Collector Modal -->
      <div id="addCollectorModal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeAddCollectorModal()">&times;</span>
          <h2>Add New Collector</h2>
          <form method="POST" action="{% url 'ecotracksys:collector_management' %}" autocomplete="off">
            {% csrf_token %}
            <label for="collector_name">Full Name</label>
            <input type="text" id="collector_name" name="collector_name" placeholder="Enter full name" required>
            <label for="collector_email">Email Address</label>
            <input type="email" id="collector_email" name="collector_email" placeholder="Enter email" required autocomplete="new-email">
            <label for="collector_phone">Phone Number</label>
            <input type="text" id="collector_phone" name="collector_phone" placeholder="Enter phone number" required>
            <label for="collector_password">Password</label>
            <input type="password" id="collector_password" name="collector_password" placeholder="Enter password" required autocomplete="new-password">
            <button type="submit" class="save-btn">Save Collector</button>
          </form>
        </div>
      </div>

      <!-- Delete Collector Modal -->
      <div id="deleteCollectorModal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeDeleteCollectorModal()">&times;</span>
          <h2 style="color: red;">Delete Collector</h2>
          <p id="deleteMessage" style="margin-bottom: 20px;"></p>
          <form method="POST" id="deleteCollectorForm">
            {% csrf_token %}
            <button type="submit" class="save-btn" style="background-color: red;">Yes, Delete</button>
            <button type="button" class="save-btn" style="background-color: gray;" onclick="closeDeleteCollectorModal()">Cancel</button>
          </form>
        </div>
      </div>

      <!-- Edit Collector Modal -->
      <div id="editCollectorModal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeEditCollectorModal()">&times;</span>
          <h2>Edit Collector</h2>
          <form method="POST" id="editCollectorForm" autocomplete="off">
            {% csrf_token %}
            <label for="edit_collector_name">Full Name</label>
            <input type="text" id="edit_collector_name" name="collector_name" required>
            <label for="edit_collector_email">Email Address</label>
            <input type="email" id="edit_collector_email" name="collector_email" required>
            <label for="edit_collector_phone">Phone Number</label>
            <input type="text" id="edit_collector_phone" name="collector_phone" required>
            <label for="edit_collector_password">Password (leave blank to keep unchanged)</label>
            <input type="password" id="edit_collector_password" name="collector_password">
            <button type="submit" class="save-btn">Save Changes</button>
          </form>
        </div>
      </div>

    </div> <!-- End main -->
  </div> <!-- End container -->

  <!-- =========================== JavaScript =========================== -->
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    // ========================= Sidebar Toggle =========================
    window.toggleSidebar = function () {
      document.getElementById("sidebar").classList.toggle("collapsed");
    }

    // ========================= Profile Menu Toggle =========================
    window.toggleProfileMenu = function () {
      const menu = document.getElementById("profileDropdown");
      menu.style.display = menu.style.display === "block" ? "none" : "block";
    }

    // ========================= Add / Edit Collector Modals =========================
    window.openAddCollectorModal = function () {
      document.getElementById("addCollectorModal").style.display = "block";
    }
    window.closeAddCollectorModal = function () {
      document.getElementById("addCollectorModal").style.display = "none";
    }

    window.openEditCollectorModal = function (collector) {
      const modal = document.getElementById("editCollectorModal");
      modal.style.display = "block";

      // Pre-fill form with collector data
      document.getElementById("edit_collector_name").value = collector.name;
      document.getElementById("edit_collector_email").value = collector.email;
      document.getElementById("edit_collector_phone").value = collector.phone;
      document.getElementById("edit_collector_password").value = "";

      // Update form action URL dynamically
      document.getElementById("editCollectorForm").action = "{% url 'ecotracksys:edit_collector' 0 %}".replace('0', collector.id);
    }
    window.closeEditCollectorModal = function () {
      document.getElementById("editCollectorModal").style.display = "none";
    }

    // ========================= Delete Collector Modal =========================
    window.openDeleteCollectorModal = function (collectorId, collectorName) {
      const modal = document.getElementById("deleteCollectorModal");
      modal.style.display = "block";

      // Show message inside modal
      document.getElementById("deleteMessage").innerText =
        `Are you sure you want to delete collector "${collectorName}"?`;

      // Set correct action URL
      document.getElementById("deleteCollectorForm").action =
        "{% url 'ecotracksys:delete_collector' 0 %}".replace("0", collectorId);
    }

    window.closeDeleteCollectorModal = function () {
      document.getElementById("deleteCollectorModal").style.display = "none";
    }

    // ========================= Close modals / profile menu if clicked outside =========================
    window.onclick = function (event) {
      const addModal = document.getElementById("addCollectorModal");
      const editModal = document.getElementById("editCollectorModal");
      const profileMenu = document.getElementById("profileDropdown");

      if (event.target === addModal) closeAddCollectorModal();
      if (event.target === editModal) closeEditCollectorModal();
      if (!document.querySelector(".profile-menu").contains(event.target)) {
        profileMenu.style.display = "none";
      }
    }

    // ========================= CSRF Helper Function =========================
    function getCSRFToken() {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          cookie = cookie.trim();
          if (cookie.startsWith('csrftoken=')) {
            cookieValue = decodeURIComponent(cookie.substring('csrftoken='.length));
            break;
          }
        }
      }
      return cookieValue;
    }

  })();
  </script>
</body>
</html>
