{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Complaints Management | EcoTrack</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  
  <style>
    /* =========================
       Root Theme Variables
       ========================= */
    :root {
      --bg-image: url("{% static 'images/bgimg.jpg' %}");
      --container-gradient: linear-gradient(145deg, rgba(4, 57, 39, 0.9), rgba(5, 111, 79, 0.85));
      --primary: #04706e;         /* main accent */
      --secondary: #2f9080;       /* secondary tone */
      --highlight: #85fcde;       /* minty highlight */
      --light-blue: #85fcde;      /* alias for highlight (fix for undefined var) */
      --shadow: rgba(3, 104, 77, 0.5); /* depth shadow */
      --text-light: #e6fef3;      /* light text */
      --text-dark: #0b3d2e;       /* dark text */
    }

    /* =========================
       Base Page Styles
       ========================= */
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg-image) no-repeat center center/cover;
      color: var(--text-dark);
    }

    .container {
      display: flex; 
      min-height: 100vh; 
      background: linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(103, 206, 168, 0.7));
    }

    /* =========================
       Sidebar Styles
       ========================= */
    .sidebar {
      width: 260px;
      background: linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(103, 206, 168, 0.7));
      transition: width 0.3s ease, padding 0.3s ease;
      box-shadow: 2px 0 12px var(--shadow);
      backdrop-filter: blur(12px);
    }
    .sidebar.collapsed { width: 70px; padding: 0; }
    .sidebar h2 {
      text-align: center; padding: 20px 0;
      font-size: 1.6rem; margin: 0;
      color: var(--primary);
    }
    .sidebar.collapsed h2 { opacity: 0; }
    .sidebar ul { list-style: none; padding: 0; margin: 0; }
    .sidebar ul li a {
      display: flex; align-items: center; gap: 12px;
      padding: 14px 22px; text-decoration: none;
      border-radius: 8px; transition: background 0.3s ease;
      color: var(--text-dark);
    }
    .sidebar ul li a:hover { background: var(--secondary); color: #fff; }
    .sidebar ul li a.active { background: var(--primary); color: #fff; font-weight: bold; }
    .sidebar.collapsed ul li span { display: none; }

    /* Sidebar toggle button */
    .toggle-btn {
      position: absolute; top: 12px; right: 12px;
      background: none; border: none;
      font-size: 22px; color: var(--text-dark);
      cursor: pointer;
    }

    /* =========================
       Main Content
       ========================= */
    .main {
      flex: 1; padding: 24px;
      backdrop-filter: blur(6px);
    }
    .header {
      font-size: 26px; font-weight: bold;
      color: var(--primary);
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 24px;
    }
    .header h1 { font-size: 26px; }

    /* =========================
       Complaints Table
       ========================= */
    table {
      width: 100%; border-collapse: collapse;
      background: white; 
      border-radius: 12px; overflow: hidden;
      box-shadow: 0 4px 12px var(--shadow);
    }
    th, td {
      padding: 16px; text-align: left;
      border-bottom: 1px solid rgba(3, 104, 77, 0.2);
    }
    th {
      background: var(--primary); color: #fff;
    }
    tr:hover { background-color: rgba(4, 112, 110, 0.08); }
/* Profile box */
    .profile-box {
      flex: 1 1 300px;
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(10px);
      padding:20px;
      border-radius:16px;
      box-shadow:0 4px 20px var(--shadow);
      color: #0b3d2e;
    }

    .profile-menu {
  position: absolute;
  top: 16px;
  right: 30px;
}
/* Profile Image */
.profile-img {
  width: 50px;
  height: 50px;     /* make width and height equal */
  border-radius: 50%;
  object-fit: cover; /* fill the circle without distortion */
  border: 2px solid var(--primary);
  cursor: pointer;
  display: block;
}


/* Dropdown Menu */
.profile-dropdown {
  display: none;
  position: absolute;
  right: 0;
  top: 55px;
  background: white;
  border-radius: 10px;
  box-shadow: 0 4px 15px var(--shadow);
  overflow: hidden;
  z-index: 1000;
  min-width: 150px;
}
/* Dropdown Links */
.profile-dropdown a {
  display: block;
  padding: 10px 14px;
  text-decoration: none;
  color: var(--text-dark);
  font-size: 14px;
  transition: background 0.2s;
}

.profile-dropdown a:hover {
  background: var(--secondary);
}

    /* Status badges */
    .status-badge {
      padding: 4px 10px; border-radius: 12px;
      font-size: 13px; font-weight: 600;
      display: inline-block; text-align: center;
      min-width: 70px;
    }
    .status-pending { background-color: orange; color: #fff; }
    .status-resolved { background-color: limegreen; color: #fff; }

    /* =========================
       Profile Dropdown
       ========================= */
    .profile-menu { position: absolute; top: 16px; right: 30px; }
    .profile-img {
      width: 50px; height: 50px;
      border-radius: 50%; object-fit: cover;
      border: 2px solid var(--primary);
      cursor: pointer; display: block;
    }
    .profile-dropdown {
      display: none; position: absolute;
      right: 0; top: 55px;
      background: white; border-radius: 10px;
      box-shadow: 0 4px 15px var(--shadow);
      overflow: hidden; z-index: 1000; min-width: 150px;
    }
    .profile-dropdown a {
      display: block; padding: 10px 14px;
      text-decoration: none; color: var(--text-dark);
      font-size: 14px; transition: background 0.2s;
    }
    .profile-dropdown a:hover { background: var(--secondary); color: #fff; }

    /* =========================
       Action Buttons
       ========================= */
    .actions { display: flex; gap: 10px; }
    .action-btn {
      background: none; border: none; cursor: pointer;
      font-size: 18px; color: var(--primary);
      transition: all 0.2s ease-in-out;
    }
    .action-btn:hover { color: var(--secondary); transform: scale(1.1); }

    /* =========================
       Modals
       ========================= */
    .modal {
      display: none; position: fixed; z-index: 1000;
      left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(15,32,39,0.9); backdrop-filter: blur(5px);
    }
    .modal-content {
      background: #1c2b4a;
      margin: 8% auto; padding: 30px;
      border-radius: 12px; width: 90%; max-width: 500px;
      box-shadow: 0 4px 12px var(--shadow);
      color: var(--text-light); position: relative;
    }
    .close-btn {
      position: absolute; top: 12px; right: 16px;
      font-size: 28px; font-weight: bold; cursor: pointer;
      color: var(--highlight); transition: color 0.3s ease;
    }
    .close-btn:hover { color: var(--light-blue); }
    .modal-content h2 { margin-top: 0; color: var(--highlight); }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 6px; color: var(--light-blue); }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 10px; border-radius: 6px;
      border: none; background-color: #273b61;
      color: var(--text-light);
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: 2px solid var(--primary);
    }
    .submit-btn {
      padding: 10px 18px; background-color: var(--primary);
      border: none; color: white; border-radius: 6px;
      cursor: pointer; font-size: 14px;
      transition: background 0.3s ease;
    }
    .submit-btn:hover { background-color: var(--secondary); }

    /* =========================
       Responsive
       ========================= */
    @media screen and (max-width: 768px) {
      .sidebar { position: fixed; z-index: 999; height: 100%; }
      .main { margin-left: 70px; }
      .sidebar.collapsed + .main { margin-left: 70px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <h2>EcoTrack</h2>
     <button class="toggle-btn" onclick="toggleSidebar()" aria-label="Toggle Sidebar">â˜°</button>
      <ul>
        <li><a href="{% url 'ecotracksys:admin_dashboard' %}" ><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
  <li><a href="{% url 'ecotracksys:pickup_management' %}"><i class="fas fa-trash"></i> <span>Pickup Management</span></a></li>
  
  <li><a href="{% url 'ecotracksys:leave_request_management' %}"><i class="fas fa-calendar-alt"></i> <span>Leave Requests</span></a></li>
  <li><a href="{% url 'ecotracksys:complaint_management' %}" class="active"><i class="fas fa-bullhorn"></i> <span>Complaints</span></a></li>
  <li><a href="{% url 'ecotracksys:user_management' %}"><i class="fas fa-users"></i> <span>User Management</span></a></li>
  <li><a href="{% url 'ecotracksys:collector_management' %}"><i class="fas fa-user-cog"></i> <span>Collector Management</span></a></li>
  <li><a href="{% url 'ecotracksys:admin_analytics' %}"><i class="fas fa-chart-line"></i> <span>Analytics</span></a></li>
  <li><a href="{% url 'ecotracksys:admin_notifications' %}" ><i class="fas fa-bell"></i> <span>Notifications</span></a></li>
  <li><a href="{% url 'ecotracksys:admin_profile' %}"><i class="fas fa-user-shield"></i> <span>Admin Profile</span></a></li>
      </ul>
    </div>

    <!-- Main Content -->
    <div class="main">
      <div class="profile-menu">
        {% if user.is_authenticated %}
          {% if request.user.profile_image %}
            <img src="{{ request.user.profile_image.url }}" alt="Profile Image" class="profile-img" onclick="toggleProfileMenu()">
          {% else %}
            <img src="{% static 'default_profile.png' %}" alt="Profile Image" class="profile-img" onclick="toggleProfileMenu()">
          {% endif %}
        {% endif %}



  <!-- Dropdown Menu -->
  <div class="profile-dropdown" id="profileDropdown">
    <a href="{% url 'ecotracksys:admin_profile' %}">ðŸ‘¤ View Profile</a>
    <a href="{% url 'logout' %}">ðŸšª Logout</a>
  </div>
</div>
      <div class="header">
        <h1>Complaints Management</h1>
      </div>

      <!-- Complaints Table -->
      <table>
        <thead>
          <tr>
            <th>Complaint ID</th>
            <th>User</th>
            <th>Description</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for complaint in complaints %}
          <tr>
            <td>{{ complaint.id }}</td>
            <td>{{ complaint.user }}</td>
            <td>{{ complaint.description }}</td>
            <td>
              <span class="status-badge {% if complaint.status == 'Resolved' %}status-resolved{% else %}status-pending{% endif %}">
                {{ complaint.status }}
              </span>
            </td>
            <td class="actions">
              <button class="action-btn" title="Update Status" onclick="openStatusModal('{{ complaint.id }}','{{ complaint.status }}')">
                <i class="bi bi-pencil-square"></i>
              </button>
              <button class="action-btn" title="Delete" onclick="openDeleteModal('{{ complaint.id }}')">
                <i class="bi bi-trash-fill"></i>
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Update Status Modal -->
  <div id="statusModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('statusModal')">&times;</span>
      <h2>Update Complaint Status</h2>
      <form method="POST" action="{% url 'ecotracksys:update_complaint_status' %}">
        {% csrf_token %}
        <input type="hidden" name="complaint_id" id="modalComplaintId">
        <div class="form-group">
          <label for="modalStatus">Status</label>
          <select name="status" id="modalStatusSelect">
            <option value="Pending">Pending</option>
            <option value="Resolved">Resolved</option>
          </select>
        </div>
        <div class="form-group">
          <label for="modalNote">Note (Optional)</label>
          <textarea name="note" id="modalNote" rows="3" placeholder="Add remarks..."></textarea>
        </div>
        <button type="submit" class="submit-btn">Update Status</button>
      </form>
    </div>
  </div>
<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal('deleteModal')">&times;</span>
    <h2>Confirm Delete</h2>
    <!-- Form action will be set dynamically via JS -->
    <form method="POST" id="deleteForm">
      {% csrf_token %}
      <input type="hidden" name="complaint_id" id="deleteComplaintId">
      <p>Are you sure you want to delete this complaint?</p>
      <button type="submit" class="submit-btn">Yes, Delete</button>
    </form>
  </div>
</div>

  <!-- =======================
       Scripts
       ======================= -->
  <script>
    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("collapsed");
    }

    // Status Modal
    function openStatusModal(complaintId, currentStatus) {
      document.getElementById('statusModal').style.display = 'block';
      document.getElementById('modalComplaintId').value = complaintId;
      document.getElementById('modalStatusSelect').value = currentStatus;
      document.getElementById('modalNote').value = '';
    }

      // Delete Modal
  function openDeleteModal(complaintId) {
    document.getElementById('deleteModal').style.display = 'block';
    document.getElementById('deleteComplaintId').value = complaintId;

    // dynamically update the form action
    const form = document.getElementById('deleteForm');
    form.action = `/dashboard/admin/complaints/delete/${complaintId}/`;
  }

  // Close Modal
  function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
  }

  // Close modal when clicking outside
  window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
      event.target.style.display = 'none';
    }
  }
  </script>
</body>
</html>
