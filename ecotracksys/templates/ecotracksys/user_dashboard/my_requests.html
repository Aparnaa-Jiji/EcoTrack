{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Requests ‚Äì EcoTrack</title>
  <link rel="icon" href="{% static 'favicon.ico' %}">
  <style>
    /* Body */
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(145deg, #e6f7ed, #c9f0dd);
      color: #064e3b;
    }

    /* Container */
    .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }

    /* Page Header */
    .page-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 30px; }
    .page-header h1 {
      font-size: 28px; font-weight: 700;
      background: linear-gradient(90deg, #34d399, #10b981);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: flex; align-items: center; gap: 6px;
    }
    .page-header p { font-size: 14px; color: #065f46; margin-top: 4px; }

    /* Action Buttons */
    .top-actions { display: flex; gap: 12px; flex-wrap: wrap; }
    .btn {
      padding: 10px 18px; font-weight: 600; border-radius: 8px; border: none; cursor: pointer;
      transition: all 0.2s ease; text-decoration: none; color: white; display: inline-flex; align-items: center; gap: 6px;
    }
    .btn-primary { background: linear-gradient(145deg, #34d399, #10b981); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(16,185,129,0.4); }
    .btn-secondary { background: #3b82f6; }
    .btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(59,130,246,0.4); }

    /* Filter Bar */
    .filter-bar { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 25px; }
    .filter-bar select, .filter-bar input {
      padding: 8px 12px; border-radius: 6px; border: 1px solid #6ee7b7;
      background: linear-gradient(145deg, #d1fae5, #a7f3d0); font-size: 14px; color: #064e3b;
    }

    /* Request Card */
    .request-card {
      background: linear-gradient(145deg, #d9f3e2, #a7f0c5); border-radius: 12px; padding: 20px; margin-bottom: 20px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.08); transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .request-card:hover { transform: translateY(-2px); box-shadow: 0 10px 22px rgba(0,0,0,0.15); }

    .request-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .request-id { font-weight: 600; color: #064e3b; font-size: 16px; }
    .status-badge {
      padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600;
      color: white; text-transform: uppercase;
    }
    .status-pending { background: #a3e635; }
    .status-in-progress { background: #4ade80; }
    .status-completed { background: #22c55e; }
    .status-cancelled { background: #ef4444; }

    /* Details Grid */
    .request-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 13px; color: #065f46; }
    .request-details span { display: block; }

    /* Action Buttons */
    .action-buttons { margin-top: 15px; display: flex; gap: 8px; flex-wrap: wrap; }
    .btn-action { padding: 6px 14px; font-size: 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; color: white; transition: all 0.2s ease; }
    .btn-edit { background: #22c55e; }
    .btn-cancel { background: #ef4444; }
    .btn-action:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Empty State */
    .empty-state { text-align: center; padding: 60px 20px; color: #16a34a; }
    .empty-state-icon { font-size: 50px; opacity: 0.4; margin-bottom: 10px; }

    /* Glassy Modal */
    .modal {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); justify-content: center; align-items: center;
    }
    .modal-content {
      background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 16px; padding: 30px;
      width: 90%; max-width: 400px; text-align: center; color: #064e3b;
    }
    .modal-content h2 { margin-bottom: 20px; }
    .modal-content form label { display: block; margin-bottom: 12px; text-align: left; font-size: 14px; }
    .modal-content form input, .modal-content form textarea { width: 100%; padding: 8px 10px; margin-top: 4px; border-radius: 6px; border: 1px solid #6ee7b7; font-size: 14px; }
    .modal-actions { display: flex; justify-content: space-between; margin-top: 20px; }
  </style>
</head>
<body>
<div class="container">
  <!-- Header -->
  <div class="page-header">
    <div>
      <h1>üìã My Requests</h1>
      <p>Quickly view and manage your pickup requests</p>
    </div>
    <div class="top-actions">
      <a href="{% url 'ecotracksys:citizen_pickup_request' %}" class="btn btn-primary">‚ûï New Pickup</a>
      <a href="{% url 'ecotracksys:citizen_dashboard' %}" class="btn btn-secondary">üè† Dashboard</a>
    </div>
  </div>

  <!-- Filter Bar -->
  <div class="filter-bar">
    <select id="status-filter">
      <option value="">All Status</option>
      <option value="pending">Pending</option>
      <option value="in-progress">In Progress</option>
      <option value="completed">Completed</option>
      <option value="cancelled">Cancelled</option>
    </select>
    <select id="date-filter">
      <option value="">All Time</option>
      <option value="today">Today</option>
      <option value="week">This Week</option>
      <option value="month">This Month</option>
    </select>
    <input type="text" id="search-input" placeholder="Search by address or notes...">
  </div>

  <!-- Requests List -->
  <div id="requests-container">
    {% if requests %}
      {% for req in requests %}
        <div class="request-card"
             data-id="{{ req.id }}"
             data-pickup_date="{{ req.pickup_date }}"
             data-pickup_time_slot="{{ req.pickup_time_slot }}"
             data-address="{{ req.address }}"
             data-waste_type="{{ req.waste_type }}"
             data-quantity="{{ req.quantity }}"
             data-status="{{ req.status|lower }}">
          <div class="request-header">
            <span class="request-id">Request #{{ req.id }}</span>
            <span class="status-badge status-{{ req.status|lower }}">{{ req.status }}</span>
          </div>
          <div class="request-details">
            <span><strong>Date:</strong> {{ req.pickup_date|date:"M d, Y" }}</span>
            <span><strong>Time Slot:</strong> {{ req.pickup_time_slot }}</span>
            <span><strong>Type:</strong> {{ req.waste_type }}</span>
            <span><strong>Quantity:</strong> {{ req.quantity }}</span>
            <span><strong>Address:</strong> {{ req.address }}</span>
            <span><strong>Collector:</strong> {{ req.collector.get_full_name|default:"Not assigned" }}</span>
          </div>
          <div class="action-buttons">
            {% if req.status != 'Cancelled' and req.status != 'Completed' %}
              <button class="btn-action btn-edit" data-id="{{ req.id }}">‚úèÔ∏è Edit</button>
              <button class="btn-action btn-cancel" data-id="{{ req.id }}">‚ùå Cancel</button>
            {% else %}
              <button class="btn-action btn-edit" disabled>‚úèÔ∏è Edit</button>
              <button class="btn-action btn-cancel" disabled>‚ùå Cancel</button>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="empty-state">
        <div class="empty-state-icon">üì≠</div>
        <p>You have no pickup requests yet.</p>
        <a href="{% url 'ecotracksys:citizen_pickup_request' %}" class="btn btn-primary">Make a Request</a>
      </div>
    {% endif %}
  </div>
</div>

<!-- Cancel Modal -->
<div id="cancelModal" class="modal">
  <div class="modal-content">
    <h2>‚ùå Cancel Pickup Request</h2>
    <p>Are you sure you want to cancel this pickup request?</p>
    <div class="modal-actions">
      <button id="confirmCancel" class="btn btn-cancel">Yes, Cancel</button>
      <button id="closeCancel" class="btn btn-secondary">No</button>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <h2>‚úèÔ∏è Edit Pickup Request</h2>
    <form id="editForm">
      <label>
        Pickup Date:
        <input type="date" name="pickup_date" required>
      </label>
      <label>
        Time Slot:
        <input type="text" name="pickup_time_slot" placeholder="10:00 - 12:00" required>
      </label>
      <label>
        Address:
        <input type="text" name="address" required>
      </label>
      <label>
        Waste Category:
        <input type="text" name="waste_type" required>
      </label>
      <label>
        Quantity:
        <input type="number" name="quantity" min="1" required>
      </label>
      <div class="modal-actions">
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <button type="button" id="closeEditModal" class="btn btn-secondary">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Filtering logic
  const statusFilter = document.getElementById('status-filter');
  const dateFilter = document.getElementById('date-filter');
  const searchInput = document.getElementById('search-input');
  const cards = document.querySelectorAll('.request-card');

  function filterRequests() {
    const statusValue = statusFilter.value.toLowerCase();
    const dateValue = dateFilter.value.toLowerCase();
    const searchValue = searchInput.value.toLowerCase();
    const now = new Date();

    function matchesDate(dateStr) {
      const date = new Date(dateStr);
      if(dateValue === 'today') return date.toDateString() === now.toDateString();
      if(dateValue === 'week') {
        const weekAgo = new Date(); weekAgo.setDate(now.getDate() - 7);
        return date >= weekAgo && date <= now;
      }
      if(dateValue === 'month') return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
      return true;
    }

    cards.forEach(card => {
      const matchesStatus = !statusValue || statusValue === card.dataset.status;
      const matchesDateValue = matchesDate(card.dataset.pickup_date);
      const matchesSearch = card.textContent.toLowerCase().includes(searchValue);
      card.style.display = (matchesStatus && matchesDateValue && matchesSearch) ? '' : 'none';
    });
  }

  statusFilter.addEventListener('change', filterRequests);
  dateFilter.addEventListener('change', filterRequests);
  searchInput.addEventListener('input', filterRequests);

  // Cancel Modal
  const cancelButtons = document.querySelectorAll('.btn-cancel[data-id]');
  const cancelModal = document.getElementById('cancelModal');
  const closeCancel = document.getElementById('closeCancel');
  const confirmCancel = document.getElementById('confirmCancel');
  let currentCancelId = null;

  cancelButtons.forEach(btn => btn.addEventListener('click', () => {
    currentCancelId = btn.dataset.id;
    cancelModal.style.display = 'flex';
  }));

  closeCancel.addEventListener('click', () => { cancelModal.style.display = 'none'; currentCancelId = null; });

  confirmCancel.addEventListener('click', () => {
    if(!currentCancelId) return;
    fetch("{% url 'ecotracksys:cancel_pickup_request' %}", {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},
      body: JSON.stringify({request_id: currentCancelId})
    }).then(res => res.json())
      .then(data => { alert(data.message || data.error); location.reload(); })
      .catch(err => alert(err))
      .finally(() => { cancelModal.style.display = 'none'; currentCancelId = null; });
  });

  // Edit Modal
  const editButtons = document.querySelectorAll('.btn-edit[data-id]');
  const editModal = document.getElementById('editModal');
  const closeEditBtn = document.getElementById('closeEditModal');
  const editForm = document.getElementById('editForm');
  let currentEditId = null;

  editButtons.forEach(btn => btn.addEventListener('click', () => {
    const card = btn.closest('.request-card');
    currentEditId = card.dataset.id;
    editForm.pickup_date.value = card.dataset.pickup_date;
    editForm.pickup_time_slot.value = card.dataset.pickup_time_slot;
    editForm.address.value = card.dataset.address;
    editForm.waste_type.value = card.dataset.waste_type;
    editForm.quantity.value = card.dataset.quantity;
    editModal.style.display = 'flex';
  }));

  closeEditBtn.addEventListener('click', () => { editModal.style.display = 'none'; currentEditId = null; });

  editForm.addEventListener('submit', function(e) {
    e.preventDefault();
    if(!currentEditId) return;
    fetch("{% url 'ecotracksys:edit_pickup_request' %}", {
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},
      body:JSON.stringify({
        request_id: currentEditId,
        pickup_date: editForm.pickup_date.value,
        pickup_time_slot: editForm.pickup_time_slot.value,
        address: editForm.address.value,
        waste_type: editForm.waste_type.value,
        quantity: editForm.quantity.value
      })
    }).then(res=>res.json())
      .then(data=>{ alert(data.message||data.error); location.reload(); })
      .catch(err=>alert(err))
      .finally(()=>{ editModal.style.display='none'; currentEditId=null; });
  });
</script>
</body>
</html>
