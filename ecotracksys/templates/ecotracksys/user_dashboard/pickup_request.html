{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pickup Request | EcoTrack</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body {
  font-family: 'Segoe UI', 'Roboto', sans-serif;
  margin: 0;
  min-height: 100vh;
  color: #064e3b;
  background-image: url("{% static 'user_bg.jpg' %}");
  background-size: cover;
  background-position: center;
}

.pickup-form-wrapper {
  background: rgba(198, 255, 220, 0.85);
  border-radius: 15px;
  padding: 30px;
  max-width: 800px;
  margin: 40px auto;
  box-shadow: 0 8px 16px rgba(0,0,0,0.2);
  backdrop-filter: blur(8px);
  position: relative;
}

.home-btn {
  position: absolute;
  top: 20px;
  left: 20px;
  width: 46px;
  height: 46px;
  border-radius: 50%;
  background: linear-gradient(135deg, #059669 0%, #10b981 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 22px;
  text-decoration: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  transition: transform 0.3s, box-shadow 0.3s;
}
.home-btn:hover { transform: scale(1.1) rotate(-10deg); box-shadow:0 6px 16px rgba(0,0,0,0.35); }

.pickup-form-wrapper h3 {
  text-align: center;
  font-size: 26px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  margin-bottom: 30px;
  color: #10b981;
}

.user-profile {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
}
.user-profile img {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid #4ade80;
  box-shadow: 0 0 10px rgba(16,185,129,0.6);
}
.user-profile .name { font-size: 1.2rem; font-weight: 700; color: #16a34a; }

.form-row { display: flex; gap: 16px; flex-wrap: wrap; }
.form-col { flex: 1; min-width: 150px; }

.pickup-form-wrapper label { display: block; margin-top: 12px; font-weight: 600; color: #064e3b; }

.pickup-form-wrapper input,
.pickup-form-wrapper textarea,
.pickup-form-wrapper select {
  width: 100%;
  padding: 10px 14px;
  border-radius: 8px;
  border: 2px solid #4ade80;
  background: rgba(255, 255, 255, 0.85);
  color: #064e3b;
  font-size: 1rem;
  outline: none;
  height: 38px;
}
.pickup-form-wrapper textarea { height: auto; }
.pickup-form-wrapper input:focus,
.pickup-form-wrapper textarea:focus,
.pickup-form-wrapper select:focus {
  border-color: #10b981;
  box-shadow: 0 0 0 2px rgba(16,185,129,0.4);
}

.map-button {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
  border-radius: 8px;
  color: #fff;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  font-size: 0.95rem;
  margin-top: 24px;
}
.map-button:hover { transform: translateY(-2px) scale(1.05); }

.pickup-form-wrapper button {
  width: 220px;
  padding: 12px 0;
  margin: 20px auto 0 auto;
  display: block;
  font-weight: 700;
  font-size: 1.05rem;
  color: #fff;
  background: linear-gradient(180deg, #34d399 0%, #10b981 60%, #059669 100%);
  border: none;
  border-radius: 8px;
  cursor: pointer;
  box-shadow: 0 4px 0 #059669, 0 8px 12px rgba(0,0,0,0.2);
}
.pickup-form-wrapper button:hover { transform: translateY(-3px) scale(1.05); }

#errorMessage, #locationError {
  color: #b91c1c;
  font-weight: bold;
  margin-top: 8px;
  display: none;
}

#modalMapContainer {
  display: none;
  position: fixed;
  top: 10%;
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  max-width: 600px;
  height: 450px;
  z-index: 1000;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.4);
  flex-direction: column;
  display: none;
}
#modalMapHeader {
  display:flex; justify-content:space-between; align-items:center;
  padding:8px 12px; background:#10b981; color:#fff;
  border-top-left-radius:12px; border-top-right-radius:12px;
}
#modalMapHeader button { background:#fff; color:#10b981; border:none; border-radius:6px; padding:4px 8px; cursor:pointer; }
#modalSearch { display:flex; gap:6px; margin:8px; }

#modalMap { flex:1; width:100%; border-radius:12px; }

@media (max-width: 768px) {
  .pickup-form-wrapper { width: 90%; padding: 20px; }
  .form-col { min-width: 100%; }
}
</style>
</head>
<body>

<div class="pickup-form-wrapper">
  <a href="{% url 'ecotracksys:citizen_dashboard' %}" class="home-btn">üè†</a>
  <h3>Pickup Request</h3>

  <div class="user-profile">
    {% if user.profile_image %}
      <img src="{{ user.profile_image.url }}" alt="{{ user.name }}">
    {% else %}
      <img src="{% static 'default_profile.png' %}" alt="Default Avatar">
    {% endif %}
    <span id="profile-name" class="name">{{ user.name }}</span>
  </div>

  {% if messages %}
    <div class="messages">
      {% for message in messages %}
        <div class="{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <form id="pickupForm" method="post" novalidate>
    {% csrf_token %}

    <div class="form-row">
      <div class="form-col">
        <label for="customer_name">Name</label>
        <input type="text" id="customer_name" name="customer_name" value="{{ user.name }}" required>
      </div>
      <div class="form-col">
        <label for="phone">Phone</label>
        <input type="tel" id="phone" name="phone" value="{{ user.phone }}" required>
      </div>
    </div>

    <div class="form-row">
      <div class="form-col">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" value="{{ user.email }}" required>
      </div>
      <div class="form-col">
        <label for="address">Address</label>
        <textarea id="address" name="address" rows="2">{{ user.profile.address|default_if_none:"" }}</textarea>
      </div>
    </div>

    <input type="hidden" id="lat" name="lat">
    <input type="hidden" id="lng" name="lng">

    <button type="button" class="map-button" id="geocodeBtn">üìç Locate on Map</button>
    <div id="locationError"></div>

    <div class="form-row">
      <div class="form-col">
        <label for="pickup_date">Preferred Date</label>
        <input type="date" id="pickup_date" name="pickup_date" required>
      </div>
      <div class="form-col">
        <label>Preferred Time</label>
        <div style="display:flex; gap:10px;">
          <input type="time" id="pickup_time_from" name="pickup_time_from" required>
          <input type="time" id="pickup_time_to" name="pickup_time_to" required>
        </div>
        <div id="errorMessage">‚ùå "From" time must be earlier than "To" time</div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-col">
        <label for="waste_type">Type of Waste</label>
        <select id="waste_type" name="waste_type" required>
          <option value="">-- Select --</option>
          <option value="organic">Biodegradable / Organic Waste</option>
          <option value="recyclable">Recyclable Waste</option>
          <option value="nonrecyclable">Non-Recyclable / Residual Waste</option>
          <option value="ewaste">E-Waste</option>
          <option value="hazardous">Hazardous Waste</option>
          <option value="construction">Construction & Demolition Waste</option>
        </select>
      </div>
      <div class="form-col">
        <label for="special_instructions">Special Instructions</label>
        <textarea id="special_instructions" name="special_instructions" rows="2"></textarea>
      </div>
    </div>

    <div class="form-row">
      <div class="form-col">
        <label for="quantity">Quantity (kg)</label>
        <input type="number" id="quantity" name="quantity" value="1" min="1" required>
      </div>
      <div class="form-col">
        <label for="price">Estimated Price</label>
        <input type="text" id="price" name="price" readonly value="0">
      </div>
    </div>

    <button type="submit">Submit Request</button>
  </form>
</div>

<!-- Modal Map -->
<div id="modalMapContainer">
  <div id="modalMapHeader">
    <span>Choose Location</span>
    <button id="closeMapBtn">‚úñ</button>
  </div>
  <div id="modalSearch">
    <input type="text" id="searchInput" placeholder="Search address..." style="flex:1; padding:6px 8px;">
    <button id="searchBtn">Search</button>
  </div>
  <div id="modalMap"></div>
</div>

<script>
const profileName = document.getElementById('profile-name');
const nameInput = document.getElementById('customer_name');
nameInput.addEventListener('input', ()=>{ profileName.textContent = nameInput.value || 'Your Name'; });

// Time validation
const fromTime = document.getElementById("pickup_time_from");
const toTime = document.getElementById("pickup_time_to");
const errorMessage = document.getElementById("errorMessage");
function validateTime() {
  if(fromTime.value && toTime.value && fromTime.value >= toTime.value){
    errorMessage.style.display="block"; return false;
  } else { errorMessage.style.display="none"; return true; }
}
fromTime.addEventListener("input", validateTime);
toTime.addEventListener("input", validateTime);

// Price calculation
const wasteCost = {'organic':20,'recyclable':15,'nonrecyclable':25,'ewaste':30,'hazardous':50,'construction':40};
function updatePrice(){
  const type=document.getElementById('waste_type').value;
  const qty=parseInt(document.getElementById('quantity').value)||1;
  document.getElementById('price').value=wasteCost[type]?wasteCost[type]*qty:0;
}
document.getElementById('waste_type').addEventListener('change',updatePrice);
document.getElementById('quantity').addEventListener('input',updatePrice);

// Modal map logic
const mapModal = document.getElementById('modalMapContainer');
const geocodeBtn = document.getElementById('geocodeBtn');
const closeMapBtn = document.getElementById('closeMapBtn');
const searchBtn = document.getElementById('searchBtn');
const searchInput = document.getElementById('searchInput');
const latInput = document.getElementById('lat');
const lngInput = document.getElementById('lng');
const locationError = document.getElementById('locationError');

let modalMap, marker;

geocodeBtn.addEventListener('click', ()=>{
  mapModal.style.display='flex';
  setTimeout(()=>{
    if(!modalMap){
      modalMap = L.map('modalMap').setView([20.5937,78.9629],5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(modalMap);

      modalMap.on('click', async function(e){
        const {lat,lng}=e.latlng;
        if(marker) modalMap.removeLayer(marker);
        marker = L.marker([lat,lng], {draggable:true}).addTo(modalMap);
        latInput.value=lat; lngInput.value=lng;
        marker.on('dragend', function(evt){
          const pos = evt.target.getLatLng();
          latInput.value = pos.lat; lngInput.value = pos.lng;
        });
        try{
          const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
          const data = await resp.json();
          if(data && data.display_name) document.getElementById('address').value = data.display_name;
        }catch(e){ console.error(e); }
      });
    } else {
      modalMap.invalidateSize();
    }
  }, 100);
});

closeMapBtn.addEventListener('click', ()=>{ mapModal.style.display='none'; });

searchBtn.addEventListener('click', async ()=>{
  const address = searchInput.value.trim();
  if(!address) return alert('Please enter an address.');
  try{
    const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
    const data = await resp.json();
    if(!data.length) return alert('Address not found.');
    const lat=parseFloat(data[0].lat);
    const lng=parseFloat(data[0].lon);
    if(marker) modalMap.removeLayer(marker);
    marker = L.marker([lat,lng], {draggable:true}).addTo(modalMap);
    modalMap.setView([lat,lng],15);
    latInput.value=lat; lngInput.value=lng;
    marker.on('dragend', function(evt){
      const pos = evt.target.getLatLng();
      latInput.value = pos.lat; lngInput.value = pos.lng;
    });
    document.getElementById('address').value = data[0].display_name;
  }catch(e){ alert('Error locating address'); console.error(e); }
});

// Form submit validation
const form = document.getElementById('pickupForm');
form.addEventListener('submit', function(e){
  if(!validateTime() || !latInput.value || !lngInput.value){
    e.preventDefault();
    if(!latInput.value || !lngInput.value){
      locationError.textContent='‚ùå Please select a location on the map.';
      locationError.style.display='block';
    }
  }
});
</script>

</body>
</html>
