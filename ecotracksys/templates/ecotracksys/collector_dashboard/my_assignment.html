{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>My Assignments â€” EcoTrack</title>
  
  <!-- FontAwesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  
  <style>
    :root{
      --bg:#f6fff9;
      --mint-600:#2e7d32;
      --mint-500:#43a047;
      --mint-300:#a5d6a7;
      --accent:#20c997;
      --card:#ffffff;
      --muted:#6b6b6b;
      --shadow: 0 6px 22px rgba(16,64,54,0.08);
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:linear-gradient(135deg,var(--bg),#e8faf0 60%);color:#0b3d2e;}
    
    /* Layout */
    .app{display:flex;min-height:100vh;gap:20px;}
    .sidebar{
      width:240px;
      background:linear-gradient(180deg,var(--mint-300), #e6f7ec);
      padding:18px;
      border-right:1px solid rgba(10,50,30,0.03);
      position:sticky; top:0; height:100vh; box-shadow:var(--shadow);
    }
    .brand { font-weight:700;color:var(--mint-600);font-size:1.15rem;text-align:center;margin-bottom:14px; }
    .nav { list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px; }
    .nav a{
      display:flex;align-items:center;gap:10px;padding:10px 12px;text-decoration:none;color:var(--mint-600);
      border-radius:10px;font-weight:600;
    }
    .nav a .icon{ width:28px;text-align:center;color:var(--mint-600); }
    .nav a:hover, .nav a.active{ background:var(--mint-500); color:#fff; transform:translateX(4px); box-shadow:0 6px 18px rgba(66,160,102,0.08); }
    .nav a.active .icon{ color:#fff; }

    .main{flex:1;display:flex;flex-direction:column;gap:18px;padding:22px;}

    /* Topbar */
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:rgba(255,255,255,0.85);border-radius:12px;box-shadow:var(--shadow);position:sticky;top:18px;z-index:10;}
    .greeting h1{margin:0;font-size:1.25rem;color:var(--mint-600);}
    .greeting p{margin:0;color:var(--muted);font-size:0.95rem;}
    
    .profile{position:relative;display:flex;align-items:center;gap:10px;}
    .avatar{width:40px;height:40px;border-radius:50%;border:2px solid var(--mint-500);overflow:hidden;cursor:pointer;}
    .avatar img{width:100%;height:100%;object-fit:cover;}
    .profile .menu{display:none;position:absolute;right:0;top:54px;background:#fff;border-radius:10px;box-shadow:var(--shadow);min-width:180px;z-index:20;}
    .profile.open .menu{display:block;}
    .profile .menu a{display:block;padding:10px 12px;text-decoration:none;color:#0b3d2e;font-weight:600;}
    .profile .menu a:hover{background:#f3fff7;}

    /* Assignments */
    .assignment-group{margin-bottom:20px;}
    .assignment-group h3{margin-bottom:10px;color:var(--mint-600);border-bottom:2px solid var(--mint-300);padding-bottom:4px;}
    .assignments{display:flex;flex-direction:column;gap:12px;}
    .assignment-card{background:var(--card);border-radius:12px;padding:14px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:8px;border-left:6px solid var(--mint-500);}
    .assignment-header{display:flex;justify-content:space-between;align-items:center;}
    .assignment-header h4{margin:0;color:var(--mint-600);}
    .assignment-sub{color:var(--muted);font-size:0.9rem;}
    .status-chip{padding:6px 10px;border-radius:999px;font-weight:700;font-size:0.85rem;}
    .status-assigned{background:#fff9e6;color:#8a6b00;border:1px solid #fff2d9;}
    .status-enroute{background:#e6fbff;color:#055a66;border:1px solid #dff7fb;}
    .status-done{background:#e6fbef;color:#0b6b3d;border:1px solid #dff6e9;}
    .status-cancelled{background:#fce7e6;color:#a83232;border:1px solid #f9d7d7;}
    .assignment-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
    .btn{border:none;cursor:pointer;padding:8px 10px;border-radius:8px;font-weight:700;}
    .btn.start{background:var(--accent);color:#fff;}
    .btn.enroute{background:var(--mint-500);color:#fff;}
    .btn.complete{background:var(--mint-600);color:#fff;}
    .btn.issue{background:#f0ad4e;color:#fff;}
    .btn.ghost{background:transparent;border:1px solid #e8f0ea;color:var(--mint-600);}

    /* Responsive */
    @media (max-width:880px){
      .sidebar{display:none;}
      .main{margin-left:0;padding:12px;}
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" role="navigation" aria-label="Main navigation">
      <div class="brand">EcoTrack</div>
      <nav>
        <ul class="nav" role="menu">
          <li><a href="{% url 'ecotracksys:collector_dashboard' %}"><span class="icon"><i class="fas fa-home"></i></span>Dashboard</a></li>
          <li><a href="{% url 'ecotracksys:collector_assignments' %}" class="active"><span class="icon"><i class="fas fa-list-check"></i></span>My Assignments</a></li>
          <li><a href="{% url 'ecotracksys:collector_pickup_history' %}"><span class="icon"><i class="fas fa-clock-rotate-left"></i></span>History</a></li>
          <li><a href="{% url 'ecotracksys:collector_performance' %}"><span class="icon"><i class="fas fa-chart-line"></i></span>Performance</a></li>
          <li><a href="{% url 'ecotracksys:collector_leave' %}"><span class="icon"><i class="fas fa-calendar-alt"></i></span>Leave</a></li>
          <li><a href="{% url 'ecotracksys:collector_notifications' %}"><span class="icon"><i class="fas fa-bell"></i></span>Notifications</a></li>
          <li><a href="{% url 'ecotracksys:collector_complaints' %}"><span class="icon"><i class="fas fa-cog"></i></span>Complaints</a></li>
          <li><a href="{% url 'ecotracksys:collector_profile' %}"><span class="icon"><i class="fas fa-user"></i></span>Profile</a></li>
        </ul>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main">
      <!-- Topbar -->
      <div class="topbar">
        <div class="greeting">
          <h1>Good morning, {{ user.get_full_name }} ðŸ‘‹</h1>
          <p>Hereâ€™s your route for all assignments.</p>
        </div>
        <div class="profile" id="profile">
          <div class="avatar" id="avatarBtn" tabindex="0">
            {% if request.user.profile_image %}
              <img src="{{ request.user.profile_image.url }}" alt="Profile Image" class="profile-image">
            {% else %}
              <img src="{% static 'default_profile.png' %}" alt="Profile Image" class="profile-image">
            {% endif %}
          </div>
          <div class="menu" role="menu">
            <a href="{% url 'ecotracksys:collector_profile' %}">ðŸ‘¤ View Profile</a>
            <a href="{% url 'logout' %}">ðŸšª Logout</a>
          </div>
        </div>
      </div>
<p>Total assignments: {{ assignments.count }}</p>
<ul>
{% for job in assignments %}
  <li>{{ job.address }} - {{ job.status }}</li>
{% empty %}
  <li>No assignments found.</li>
{% endfor %}
</ul>
      <!-- Assignment Groups -->
      {% regroup assignments by status as status_list %}
      {% for group in status_list %}
        <section class="assignment-group">
          {% if group.grouper == 'Pending' %}
            <h3>Assigned</h3>
          {% elif group.grouper == 'In-Progress' %}
            <h3>In Progress</h3>
          {% elif group.grouper == 'Completed' %}
            <h3>Completed</h3>
          {% elif group.grouper == 'Cancelled' %}
            <h3>Cancelled</h3>
          {% endif %}
          <div class="assignments">
            {% for job in group.list %}
              <article class="assignment-card">
                <div class="assignment-header">
                  <h4>{{ job.address }}</h4>
                  {% if job.status == 'Pending' %}
                    <span class="status-chip status-assigned">Assigned</span>
                  {% elif job.status == 'In-Progress' %}
                    <span class="status-chip status-enroute">En route</span>
                  {% elif job.status == 'Completed' %}
                    <span class="status-chip status-done">Completed</span>
                  {% elif job.status == 'Cancelled' %}
                    <span class="status-chip status-cancelled">Cancelled</span>
                  {% endif %}
                </div>
                <div class="assignment-sub">
                  {{ job.pickup_date }} {{ job.pickup_time|default:"--:--" }} â€¢ Type: {{ job.waste_type }} â€¢ Qty: {{ job.quantity }}
                </div>
                <div class="assignment-actions">
                  {% if job.phone %}
                    <a class="btn ghost" href="tel:{{ job.phone }}"><i class="fas fa-phone"></i></a>
                  {% endif %}
                  <a class="btn ghost" href="https://www.google.com/maps/search/?api=1&query={{ job.lat }},{{ job.lng }}" target="_blank"><i class="fas fa-map-location-dot"></i></a>
                  {% if job.status == 'Pending' %}
                    <button class="btn start" data-id="{{ job.id }}">Start</button>
                  {% elif job.status == 'In-Progress' %}
                    <button class="btn complete" data-id="{{ job.id }}">Complete</button>
                  {% else %}
                    <button class="btn ghost" disabled>{{ job.status }}</button>
                  {% endif %}
                  <a class="btn issue" href="{% url 'raise_issue' job.id %}">Raise Issue</a>
                </div>
              </article>
            {% endfor %}
          </div>
        </section>
      {% empty %}
        <div style="padding:18px;text-align:center;color:var(--muted)">No assignments assigned yet.</div>
      {% endfor %}
    </main>
  </div>

  <script>
    // Profile dropdown toggle
    const avatarBtn = document.getElementById('avatarBtn');
    const profile = document.getElementById('profile');
    if (avatarBtn){
      avatarBtn.addEventListener('click', ()=> profile.classList.toggle('open'));
      document.addEventListener('click', (e)=>{ if(!profile.contains(e.target)) profile.classList.remove('open'); });
    }

    // Start assignment
    document.querySelectorAll('.btn.start').forEach(btn=>{
      btn.addEventListener('click', ()=> startJob(btn));
    });

    function startJob(btn){
      const id = btn.dataset.id;
      btn.disabled = true;
      btn.textContent = 'Starting...';
      fetch(`/api/collector/assignment/${id}/start/`, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
      })
      .then(res => res.json())
      .then(data => {
        if(data.success){
          btn.textContent = 'En route';
          btn.classList.remove('start');
          btn.classList.add('enroute');
          const card = btn.closest('.assignment-card');
          card.querySelector('.status-chip').textContent = 'En route';
          card.querySelector('.status-chip').className = 'status-chip status-enroute';
        }
      }).catch(err => { console.warn(err); btn.textContent='En route'; btn.disabled=false; });
    }

    // Complete assignment
    document.querySelectorAll('.btn.complete').forEach(btn=>{
      btn.addEventListener('click', ()=> completeJob(btn));
    });

    function completeJob(btn){
      const id = btn.dataset.id;
      btn.disabled = true;
      btn.textContent = 'Completing...';
      fetch(`/api/collector/assignment/${id}/complete/`, {
        method: 'POST',
        headers: {
          'X-Requested-With':'XMLHttpRequest',
          'Content-Type':'application/json',
          'X-CSRFToken':'{{ csrf_token }}'
        }
      }).then(res => res.json())
        .then(data=>{
          if(data.success){
            btn.textContent='Completed';
            btn.disabled=true;
            const card = btn.closest('.assignment-card');
            card.querySelector('.status-chip').textContent='Completed';
            card.querySelector('.status-chip').className='status-chip status-done';
          }
        }).catch(err=>{ console.warn(err); btn.disabled=false; });
    }
  </script>
</body>
</html>
