{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>My Assignments ‚Äî EcoTrack</title>

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root {
      --bg:#f6fff9;
      --mint-600:#2e7d32;
      --mint-500:#43a047;
      --mint-300:#a5d6a7;
      --card:#fff;
      --muted:#6b6b6b;
      --shadow:0 6px 22px rgba(16,64,54,0.08);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:Inter,system-ui,Arial;
      background:linear-gradient(135deg,var(--bg),#e8faf0 60%);
      color:#0b3d2e;
    }

    .app{display:flex;min-height:100vh;gap:20px;}
    .sidebar{
      width:240px;padding:18px;
      background:linear-gradient(180deg,var(--mint-300),#e6f7ec);
      box-shadow:var(--shadow);
      position:sticky;top:0;height:100vh;
    }
    .brand{font-weight:700;font-size:1.25rem;color:var(--mint-600);text-align:center;margin-bottom:16px;}

    .nav{list-style:none;display:flex;flex-direction:column;gap:8px;}
    .nav a{
      text-decoration:none;color:var(--mint-600);font-weight:600;
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:10px;transition:.25s;
    }
    .nav a:hover,.nav a.active{background:var(--mint-500);color:#fff;transform:translateX(6px);}
    .nav a .icon{width:28px;text-align:center;}

    .main{flex:1;display:flex;flex-direction:column;gap:18px;padding:22px;}

    .topbar{
      display:flex;justify-content:space-between;align-items:center;
      padding:14px 20px;background:#fff;border-radius:14px;box-shadow:var(--shadow);
      position:sticky;top:18px;z-index:10;
    }
    .greeting h1{font-size:1.3rem;color:var(--mint-600);}
    .greeting p{color:var(--muted);font-size:.95rem;}

    .profile{position:relative;}
    .avatar{width:42px;height:42px;border-radius:50%;border:2px solid var(--mint-500);overflow:hidden;cursor:pointer;}
    .avatar img{width:100%;height:100%;object-fit:cover;}
    .menu{display:none;position:absolute;right:0;top:54px;background:#fff;border-radius:12px;box-shadow:var(--shadow);}
    .profile.open .menu{display:block;}
    .menu a{display:block;padding:12px 14px;text-decoration:none;color:#0b3d2e;font-weight:600;}
    .menu a:hover{background:#f3fff7;}

    .assignment-group{margin-bottom:20px;}
    .assignment-group h3{margin-bottom:10px;color:var(--mint-600);border-bottom:2px solid var(--mint-300);}
    .assignments{display:flex;flex-direction:column;gap:14px;}
    .assignment-card{
      background:var(--card);padding:16px;border-radius:14px;
      box-shadow:var(--shadow);border-left:6px solid var(--mint-500);
      display:flex;flex-direction:column;gap:10px;
    }
    .assignment-header{display:flex;justify-content:space-between;align-items:center;gap:12px;}
    .assignment-header h4{color:var(--mint-600);margin:0;font-size:1rem;}
    .status-chip{padding:6px 12px;border-radius:999px;font-weight:700;font-size:.85rem;}
    .status-Pending{background:#fff9e6;color:#8a6b00;}
    .status-In-Progress{background:#e6fbff;color:#055a66;}
    .status-Completed{background:#e6fbef;color:#0b6b3d;}
    .status-Cancelled{background:#fce7e6;color:#a83232;}

    .assignment-sub{color:var(--muted);font-size:.95rem;}

    .assignment-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px;}
    .btn{padding:8px 12px;border:none;border-radius:8px;font-weight:700;cursor:pointer;transition:all .2s ease;}
    .btn.update{background:var(--mint-600);color:#fff;}
    .btn.complete{background:#2e7d32;color:#fff;}
    .btn.issue{background:#f0ad4e;color:#fff;}
    .btn.ghost{background:transparent;border:1px solid #e8f0ea;color:var(--mint-600);}
    .btn.small{padding:6px 8px;font-size:.9rem;}
    .assignment-details{display:none;margin-top:10px;padding:10px;background:#fafefc;border-radius:8px;}
    .assignment-card.show-details .assignment-details{display:block;}

    /* Modal styles (simple) */
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:2000;}
    .modal-content{background:#fff;padding:24px;border-radius:14px;width:420px;max-width:95%;}
    .modal-content h2{color:var(--mint-600);margin:0 0 10px 0;}
    .modal-content textarea{width:100%;padding:10px;margin:12px 0;height:90px;resize:none;border:1px solid #ddd;border-radius:8px;}

    .status-Missed { background:#fff0f0; color:#b3261e; }

    @media(max-width:880px){.sidebar{display:none;}}

    /* Highlight hover only for cards with In-Progress status */
    .assignment-card:has(.status-In-Progress):hover,
    .assignment-card:has(.status-In\ Progress):hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 24px rgba(16,64,54,0.15);
      background: linear-gradient(180deg,#ffffff,#f5fff8);
      transition: all .25s ease;
    }

    /* --- Full-card highlight when marked in-progress --- */
    .assignment-card.in-progress:hover {
      transform: translateY(-8px);
      box-shadow: 0 18px 40px rgba(11,61,46,0.16);
      background: linear-gradient(180deg,#ffffff,#f3fff7);
      border-left-color: var(--mint-600) !important;
      cursor: pointer;
    }

    /* ‚úÖ Button hover glow effect */
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 12px rgba(67,160,71,0.45);
      filter: brightness(1.1);
    }

    /* Buttons inside hovered card should still glow individually */
    .assignment-card.in-progress:hover .btn:hover {
      box-shadow: 0 0 14px rgba(46,125,50,0.55), 0 6px 16px rgba(11,61,46,0.12);
      filter: brightness(1.15);
    }

  </style>
</head>
<body>
<!-- (rest of your template remains EXACTLY the same, unchanged) -->

<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">EcoTrack</div>
    <ul class="nav">
      
      <li><a href="{% url 'ecotracksys:collector_assignments' %}" class="active"><span class="icon"><i class="fas fa-list-check"></i></span>My Assignments</a></li>
      <li><a href="{% url 'ecotracksys:collector_pickup_history' %}"><span class="icon"><i class="fas fa-clock-rotate-left"></i></span>History</a></li>
      <li><a href="{% url 'ecotracksys:collector_performance' %}"><span class="icon"><i class="fas fa-chart-line"></i></span>Performance</a></li>
      <li><a href="{% url 'ecotracksys:collector_leave' %}"><span class="icon"><i class="fas fa-calendar-alt"></i></span>Leave</a></li>
      <li><a href="{% url 'ecotracksys:collector_notifications' %}"><span class="icon"><i class="fas fa-bell"></i></span>Notifications</a></li>
      <li><a href="{% url 'ecotracksys:collector_complaints' %}"><span class="icon"><i class="fas fa-cog"></i></span>Complaints</a></li>
      <li><a href="{% url 'ecotracksys:collector_profile' %}"><span class="icon"><i class="fas fa-user"></i></span>Profile</a></li>
    </ul>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="topbar">
      <div class="greeting">
        <h1>Hello, {{ user.name }} üëã</h1>

        <p>Here‚Äôs your route for all assignments.</p>
      </div>
      <div class="profile" id="profile">
        <div class="avatar" id="avatarBtn">
          {% if request.user.profile_image %}
            <img src="{{ request.user.profile_image.url }}" alt="Profile">
          {% else %}
            <img src="{% static 'default_profile.png' %}" alt="Profile">
          {% endif %}
        </div>
        <div class="menu">
          <a href="{% url 'ecotracksys:collector_profile' %}">üë§ View Profile</a>
          <a href="{% url 'logout' %}">üö™ Logout</a>
        </div>
      </div>
    </div>

    <p>Total assignments: {{ assignments.count }}</p>

    {% regroup assignments by status as status_list %}
    {% for group in status_list %}
    <section class="assignment-group">
      <h3>{{ group.grouper }}</h3>
      <div class="assignments">
        {% for job in group.list %}
        <article class="assignment-card">
          <div class="assignment-header">
            <h4>{{ job.address }}</h4>
            <span class="status-chip status-{{ job.status }}">{{ job.status }}</span>
          </div>

          <div class="assignment-sub">{{ job.pickup_date }} {{ job.pickup_time|default:"--:--" }} ‚Ä¢ Type: {{ job.get_waste_type_display }} ‚Ä¢ Qty: {{ job.quantity }}</div>

          <!-- actions and view details are inside same container for alignment -->
          <div class="assignment-actions">
            {% if job.phone %}
              <a class="btn ghost small" href="tel:{{ job.phone }}"><i class="fas fa-phone"></i></a>
            {% endif %}

            <a class="btn ghost small" href="https://www.google.com/maps/search/?api=1&query={{ job.lat }},{{ job.lng }}" target="_blank" title="Open in Maps">
              <i class="fas fa-map-location-dot"></i>
            </a>

{% if job.status == "Pending" or job.status == "In-Progress" or job.status == "In Progress" %}

   <!-- Complete button triggers OTP modal -->
<button type="button" class="btn complete small"
        onclick="openOtpModal({{ job.id }});">
  ‚úÖ Complete
</button>


    <form method="post" action="{% url 'ecotracksys:update_assignment_status' job.id %}" style="display:inline" onsubmit="return confirmAction('{{ job.status }}','missed')">
        {% csrf_token %}
        <input type="hidden" name="action" value="missed">
        <button type="submit" class="btn issue small">‚ùå Missed</button>
    </form>
{% endif %}



            <!-- Raise Issue (opens modal) -->
            <button type="button" class="btn issue small"
                    data-url="{% url 'ecotracksys:raise_issue' job.id %}"
                    data-jobid="{{ job.id }}"
                    onclick="openIssueModal(this); event.stopPropagation();">
              ‚ö† Raise Issue
            </button>

            <!-- View Details (now inside the same actions container) -->
            <button type="button" class="btn ghost small" onclick="toggleDetails(this)">View Details</button>
          </div>

          <div class="assignment-details">
            <p><b>Citizen:</b> {{ job.customer_name }}</p>
            <p><b>Phone:</b> {{ job.phone }}</p>
            <p><b>Waste Type:</b> {{ job.get_waste_type_display }}</p>
            <p><b>Quantity:</b> {{ job.quantity }}</p>
            <p><b>Pickup Time:</b> {{ job.pickup_date }} {{ job.pickup_time|default:"--:--" }}</p>
            {% if job.notes %}<p><b>Notes:</b> {{ job.notes }}</p>{% endif %}
          </div>
        </article>
        {% endfor %}
      </div>
    </section>
    {% empty %}
      <div style="padding:18px;text-align:center;color:var(--muted)">No assignments assigned yet.</div>
    {% endfor %}
  </main>
</div>

<!-- OTP Modal -->
<div id="otpModal" class="modal">
  <div class="modal-content">
    <h2>Enter OTP to Complete</h2>
    <form id="otpForm">
      {% csrf_token %}
      <input type="hidden" name="job_id" id="otpJobId">
      <label>
        OTP:
        <input type="text" name="otp" required placeholder="Enter OTP">
      </label>
      <p id="otpMessage" style="font-size:.9rem;margin-top:8px;"></p>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
        <button type="submit" class="btn complete issue-submit">Submit</button>
        <button type="button" class="btn ghost" onclick="closeOtpModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Raise Issue Modal (working) -->
<div id="issueModal" class="modal">
  <div class="modal-content">
    <h2>Raise Issue</h2>
    <form id="issueForm">{% csrf_token %}
      <input type="hidden" name="job_id" id="issueJobId">
      <textarea name="description" placeholder="Describe your issue..." required></textarea>
      <p id="issueMessage" style="font-size:.9rem;"></p>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
        <button type="submit" class="btn complete issue-submit">Submit</button>
        <button type="button" class="btn ghost" onclick="closeIssueModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ===== helper: get CSRF cookie ===== */
function getCookie(name){
  let c = null;
  if (document.cookie) {
    document.cookie.split(";").forEach(v => {
      v = v.trim();
      if (v.startsWith(name + "=")) c = decodeURIComponent(v.slice(name.length + 1));
    });
  }
  return c;
}
const csrftoken = getCookie("csrftoken");

/* ===== Profile dropdown ===== */
const profile = document.getElementById('profile');
document.getElementById('avatarBtn')?.addEventListener('click', () => profile.classList.toggle('open'));
document.addEventListener('click', (e) => { if (!profile.contains(e.target)) profile.classList.remove('open'); });

/* ===== Toggle details (works on the View Details button) ===== */
function toggleDetails(btn) {
  btn.closest('.assignment-card').classList.toggle('show-details');
}

/* ===== Confirm action helper ===== */
function confirmAction(currentStatus, action) {
  // accept both "In-Progress" and "In Progress" strings just in case
  const inProgressVariants = ["In-Progress","In Progress","In Progress"];
  if (action === 'completed') {
    if (inProgressVariants.includes(currentStatus) || currentStatus === 'Pending') {
      return confirm("Mark this assignment as Completed?");
    }
    alert("Cannot complete assignment in current state.");
    return false;
  }
  if (action === 'missed') {
    if (inProgressVariants.includes(currentStatus) || currentStatus === 'Pending') {
      return confirm("Mark this assignment as Missed?");
    }
    alert("Cannot mark as missed in current state.");
    return false;
  }
  return confirm("Update assignment?");
}

/* ===== Raise Issue modal functions & AJAX submit (from your earlier working code) ===== */
function openIssueModal(el) {
  const jobUrl = el.dataset.url;
  const jobId = el.dataset.jobid || '';
  const form = document.getElementById('issueForm');
  form.dataset.url = jobUrl;
  document.getElementById('issueJobId').value = jobId;
  document.getElementById('issueMessage').textContent = '';
  document.getElementById('issueModal').style.display = 'flex';
}
function closeIssueModal() {
  document.getElementById('issueModal').style.display = 'none';
}

document.getElementById('issueForm').addEventListener('submit', async function (e) {
  e.preventDefault();
  const submitBtn = this.querySelector('.issue-submit');
  const url = this.dataset.url;
  const formData = new FormData(this);
  const msg = document.getElementById('issueMessage');

  submitBtn.disabled = true;
  submitBtn.textContent = 'Submitting...';
  msg.textContent = '';

  try {
    const resp = await fetch(url, {
      method: 'POST',
      headers: {'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest'},
      credentials: 'same-origin',
      body: formData
    });
    const data = await resp.json();
    if (data.success) {
      msg.style.color = 'green';
      msg.textContent = '‚úÖ Issue submitted';
      setTimeout(closeIssueModal, 900);
    } else {
      msg.style.color = 'red';
      msg.textContent = data.error || '‚ùå Failed to submit';
    }
  } catch (err) {
    console.error(err);
    msg.style.color = 'red';
    msg.textContent = '‚ùå Network error';
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit';
  }
});

function confirmAction(currentStatus, action) {
  const validStatuses = ["Pending","In-Progress","In Progress"];
  
  if (!validStatuses.includes(currentStatus)) {
    alert("Cannot update assignment in current state.");
    return false;
  }

  if (action === 'completed') {
    return confirm("Mark this assignment as Completed?");
  }
  if (action === 'missed') {
    return confirm("Mark this assignment as Missed?");
  }

  return confirm("Update assignment?");
}
function openOtpModal(jobId) {
  document.getElementById('otpJobId').value = jobId;
  document.getElementById('otpMessage').textContent = '';
  document.getElementById('otpModal').style.display = 'flex';
}

function closeOtpModal() {
  document.getElementById('otpModal').style.display = 'none';
}

document.getElementById('otpForm').addEventListener('submit', async function(e){
    e.preventDefault();
    const jobId = document.getElementById('otpJobId').value;
    const otp = this.otp.value;
    const msg = document.getElementById('otpMessage');
    const submitBtn = this.querySelector('.issue-submit');

    submitBtn.disabled = true;
    submitBtn.textContent = 'Verifying...';
    msg.textContent = '';

    try {
        const resp = await fetch("{% url 'ecotracksys:complete_pickup' %}", {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest'},
            body: new URLSearchParams({job_id: jobId, otp: otp})
        });
        const data = await resp.json();
        if (data.success) {
            msg.style.color = 'green';
            msg.textContent = data.message;
            setTimeout(()=>location.reload(), 800);
        } else {
            msg.style.color = 'red';
            msg.textContent = data.error;
        }
    } catch(err){
        msg.style.color = 'red';
        msg.textContent = 'Network error';
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit';
    }
});
// mark in-progress cards robustly (handles "In-Progress" and "In Progress" text)
document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('.assignment-card').forEach(card => {
    const chip = card.querySelector('.status-chip');
    if (!chip) return;
    const txt = chip.textContent.trim().toLowerCase();
    if (txt === 'in-progress' || txt === 'in progress' || txt === 'inprogress') {
      card.classList.add('in-progress');
    }
  });
});

document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('.assignment-card').forEach(function(card) {
    const chip = card.querySelector('.status-chip');
    if (!chip) return;

    // Normalize text inside the chip
    const rawText = (chip.textContent || chip.innerText || '').replace(/\s+/g, ' ').trim().toLowerCase();

    // also check the class attribute (fallback if text is different)
    const classAttr = (chip.getAttribute('class') || '').toLowerCase();

    const isInProgressText = rawText === 'in-progress' || rawText === 'in progress' || rawText === 'inprogress' || rawText.includes('in progress');
    const isInProgressClass = classAttr.includes('in-progress') || (classAttr.includes('status-in') && classAttr.includes('progress')) || classAttr.includes('progress');

    if (isInProgressText || isInProgressClass) {
      card.classList.add('in-progress');
    }
  });
});

</script>
</body>
</html>
